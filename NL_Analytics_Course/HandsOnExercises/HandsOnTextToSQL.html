<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head>
    <title>Hands-on Exercise: Building a Text-to-SQL Pipeline</title>
    <style type="text/css" media="screen">
		@import url( ../shared/style.css );
	</style>
	<script src="../shared/scormfunctions.js" type="text/javascript"></script>
	<script src="../shared/contentfunctions.js" type="text/javascript"></script>
</head>
<body>
<h1>Hands-on Exercise: Building a Robust Text-to-SQL Pipeline</h1>

<p>In this exercise, you will walk through the steps of creating a Python application that uses Claude to translate natural language questions into executable SQL queries against a sample SQLite database.</p>

<h2>Step 1: Set up the Sample Database</h2>
<p>We'll use a simple SQLite database for an imaginary e-commerce store.</p>
<pre><code>import sqlite3

# Create a connection to the database
conn = sqlite3.connect('ecommerce.db')
cursor = conn.cursor()

# Create tables
cursor.execute('''CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT, price REAL, category TEXT)''')
cursor.execute('''CREATE TABLE sales (id INTEGER PRIMARY KEY, product_id INTEGER, quantity INTEGER, sale_date TEXT)''')

# Insert some sample data
cursor.execute("INSERT INTO products VALUES (1, 'Laptop', 1200.0, 'Electronics'), (2, 'Mouse', 25.0, 'Electronics'), (3, 'Coffee Mug', 15.0, 'Kitchen')")
cursor.execute("INSERT INTO sales VALUES (1, 1, 5, '2025-01-10'), (2, 2, 20, '2025-01-12'), (3, 3, 10, '2025-01-15')")
conn.commit()</code></pre>

<h2>Step 2: Define the Schema Prompt</h2>
<p>This prompt will describe the database structure to the model.</p>
<pre><code>SCHEMA_PROMPT = """
You are a SQL expert. Given the schema below, generate a SQL query to answer the user's question.
Use only standard SQLite syntax. Return only the SQL query and nothing else.

Schema:
Table: products
- id (INTEGER, PRIMARY KEY)
- name (TEXT)
- price (REAL)
- category (TEXT)

Table: sales
- id (INTEGER, PRIMARY KEY)
- product_id (INTEGER, FOREIGN KEY to products.id)
- quantity (INTEGER)
- sale_date (TEXT, format 'YYYY-MM-DD')
"""</code></pre>

<h2>Step 3: Create the Translation Function</h2>
<pre><code>import anthropic

client = anthropic.Anthropic()

def text_to_sql(user_question):
    prompt = f"{SCHEMA_PROMPT}\n\nQuestion: {user_question}\nSQL:"

    message = client.messages.create(
        model="claude-3-5-sonnet-20241022",
        max_tokens=256,
        messages=[{"role": "user", "content": prompt}]
    )
    return message.content[0].text

# Test the function
question = "What is the total revenue for products in the Electronics category?"
sql = text_to_sql(question)
print(f"Generated SQL: {sql}")</code></pre>

<h2>Step 4: Execute and Display Results</h2>
<pre><code>def run_analytics(question):
    sql = text_to_sql(question)
    try:
        results = cursor.execute(sql).fetchall()
        print(f"Results for '{question}':")
        for row in results:
            print(row)
    except Exception as e:
        print(f"Error executing SQL: {e}")

run_analytics("List the top 3 products by total quantity sold.")</code></pre>

<h2>Challenge: Add a Self-Correction Loop</h2>
<ol>
    <li>Modify <code>run_analytics</code> to catch SQLite errors.</li>
    <li>If an error occurs, send the error message and the faulty SQL back to Claude.</li>
    <li>Ask Claude to provide a corrected version and try to execute it again.</li>
</ol>

<p>By completing this exercise, you've built the core of a natural language analytics engine, capable of turning simple questions into data-driven insights.</p>

<script type="text/javascript">
</script>
</body>
</html>
