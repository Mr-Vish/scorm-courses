<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head>
    <title>Module: Advanced SQL - CTEs and Hierarchies</title>
    <style type="text/css" media="screen">
		@import url( ../shared/style.css );
	</style>
	<script src="../shared/scormfunctions.js" type="text/javascript"></script>
	<script src="../shared/contentfunctions.js" type="text/javascript"></script>
</head>
<body>
<h1>Advanced SQL: CTEs, Window Functions, and Hierarchical Data</h1>

<p>To provide truly expert-level analytics, a natural language interface must be capable of generating sophisticated SQL that goes beyond simple <code>SELECT</code> and <code>JOIN</code> statements. This module explores complex patterns like Common Table Expressions (CTEs), recursive queries, and advanced window functions.</p>

<h2>3.2 Common Table Expressions (CTEs)</h2>
<p>CTEs (using the <code>WITH</code> clause) are essential for breaking down complex logic into readable, modular steps. LLMs are particularly good at generating CTE-based SQL because it mirrors the step-by-step reasoning process.
<ul>
    <li><strong>Scenario:</strong> "Find all customers whose total spend is above the average spend of all customers."</li>
    <li><strong>SQL with CTE:</strong>
<pre><code>WITH CustomerSpend AS (
    SELECT customer_id, SUM(amount) as total_amount
    FROM sales
    GROUP BY customer_id
),
AvgSpend AS (
    SELECT AVG(total_amount) as overall_avg FROM CustomerSpend
)
SELECT cs.customer_id, cs.total_amount
FROM CustomerSpend cs, AvgSpend as
WHERE cs.total_amount > as.overall_avg;</code></pre>
    </li>
</ul></p>

<h2>3.3 Navigating Hierarchical Data</h2>
<p>Many business datasets are hierarchical, such as organizational charts (Employee -> Manager) or product categories. Handling these requires <strong>Recursive CTEs</strong>.
<ul>
    <li><strong>Scenario:</strong> "Show me the entire management chain for employee 'John Doe'."</li>
    <li><strong>Recursive SQL:</strong>
<pre><code>WITH RECURSIVE ManagementChain AS (
    SELECT id, name, manager_id, 1 as level
    FROM employees
    WHERE name = 'John Doe'
    UNION ALL
    SELECT e.id, e.name, e.manager_id, mc.level + 1
    FROM employees e
    JOIN ManagementChain mc ON e.id = mc.manager_id
)
SELECT * FROM ManagementChain;</code></pre>
    </li>
</ul></p>

<h2>3.4 Advanced Window Functions</h2>
<p>Window functions allow you to perform calculations across a set of table rows that are related to the current row.
<ul>
    <li><strong>Moving Averages:</strong> "Show me a 7-day rolling average of our daily revenue."</li>
    <li><strong>Ranking within Groups:</strong> "Who are the top 3 sales reps in each region?" (using <code>RANK() OVER(PARTITION BY region ORDER BY sales DESC)</code>).</li>
    <li><strong>Lead and Lag:</strong> "Compare this month's sales to the previous month's for every product." (using <code>LAG(amount) OVER(ORDER BY sale_date)</code>).</li>
</ul></p>

<h2>3.5 Dynamic Pivot and Unpivot</h2>
<p>Often, data is stored in a "long" format but is more useful for analysis in a "wide" format (or vice-versa). An advanced NLA system can automatically generate the <code>PIVOT</code> or <code>CASE WHEN</code> statements needed to transform the data layout based on the user's request.</p>

<p>By mastering these advanced SQL patterns, your NL Analytics platform can provide insights that were previously only available to expert database administrators and data analysts.</p>

<script type="text/javascript">
</script>
</body>
</html>
